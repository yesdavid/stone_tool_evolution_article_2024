<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<beast namespace="beast.core:beast.evolution.alignment:beast.evolution.tree.coalescent:beast.core.util:beast.evolution.nuc:beast.evolution.operators:beast.evolution.sitemodel:beast.evolution.substitutionmodel:beast.evolution.branchratemodel:beast.evolution.likelihood" required="BEAST v2.5.0" version="2.5">

<map name="Uniform" >beast.math.distributions.Uniform</map>
<map name="Exponential" >beast.math.distributions.Exponential</map>
<map name="LogNormal" >beast.math.distributions.LogNormalDistributionModel</map>
<map name="Normal" >beast.math.distributions.Normal</map>
<map name="Beta" >beast.math.distributions.Beta</map>
<map name="Gamma" >beast.math.distributions.Gamma</map>
<map name="LaplaceDistribution" >beast.math.distributions.LaplaceDistribution</map>
<map name="prior" >beast.math.distributions.Prior</map>
<map name="InverseGamma" >beast.math.distributions.InverseGamma</map>
<map name="OneOnX" >beast.math.distributions.OneOnX</map>
<map name="Dirichlet" >beast.math.distributions.Dirichlet</map>


<data id="dnaSequence" name="alignment">
                  
DNA_SEQUENCE_PLACEHOLDER
                  
</data>
    

<run id="mcmc" spec="MCMC" chainLength="CHAINLENGTH_PLACEHOLDER">
	<state id="state" storeEvery="5000">
		<tree id="TheTree" name="stateNode" spec='beast.evolution.tree.Tree'>
	            <taxonset id="TaxonSet" spec="TaxonSet">
		TAXON_ID_PLACEHOLDER
	            </taxonset>
                <trait id="FossilSet" spec="beast.evolution.tree.TraitSet" traitname="date-backward">
		FOSSILSET_PLACEHOLDER
                    <taxa idref="TaxonSet"/>
                </trait>
        </tree>
        <stateNode idref="varValues"/>
		<stateNode idref="rootValues"/>
		<stateNode idref="covValues"/>
		<stateNode idref="FBDremovalProb"/>
		<stateNode idref="FBDrho"/>

		<!--NEW specification of the FBP parameters-->
		<parameter id="birthRate" lower="0.0" name="stateNode">1.0 </parameter>
		<parameter id="deathRate" lower="0.0" name ="stateNode">0.5 </parameter>
		<parameter id="samplingRate" lower="0.0" name ="stateNode">0.5 </parameter>

		<parameter id="FBDorigin" name="stateNode" lower="0.0">100.0</parameter>
	</state>

    <!-- Initialise a random tree to start the chain -->
    <init id="RandomTree" spec="beast.evolution.tree.RandomTree" estimate="false" initial="@TheTree" taxa="@dnaSequence">
        <populationModel id="ConstantPopulation" spec="ConstantPopulation">
            <parameter id="randomPopSize" spec="parameter.RealParameter" name="popSize">1.0</parameter>
        </populationModel>
    </init>

	<distribution id="posterior" spec="util.CompoundDistribution">
    <!-- START prior -->
    <distribution id="prior" spec="util.CompoundDistribution">
        <!-- tree prior -->


<!-- XML specification of the FBD process NEW -->
        <distribution id="FBD" spec="beast.evolution.speciation.SABirthDeathModel" 
        				conditionOnRhoSampling = "false"
        				birthRate="@birthRate" 
        				deathRate="@deathRate" 
        				samplingRate="@samplingRate" 
        				origin="@FBDorigin"
        				tree="@TheTree">
            <parameter id="FBDremovalProb" lower="0.0" name="removalProbability" upper="1.0">0.0</parameter>
            <parameter id="FBDrho" lower="0.0" name="rho" upper="1.0">0.00000001</parameter>
        </distribution>


<!-- Priors of the FBD process NEW-->
        <distribution id="birthRatePrior" spec="beast.math.distributions.Prior" x="@birthRate">
        	<distr id="birthExpMean" spec="beast.math.distributions.Exponential" mean="BDS_EXPONENTIAL_MEAN_PLACEHOLDER" offset="0.0"/>  
        </distribution>
        <distribution id="deathRatePrior" spec="beast.math.distributions.Prior" x="@deathRate">
           <distr id="deathExpMean" spec="beast.math.distributions.Exponential" mean="BDS_EXPONENTIAL_MEAN_PLACEHOLDER" offset="0.0"/> 
        </distribution>
        <distribution id="sampleRatePrior" spec="beast.math.distributions.Prior" x="@samplingRate">
			<distr id="sampleExpMean" spec="beast.math.distributions.Exponential" mean="BDS_EXPONENTIAL_MEAN_PLACEHOLDER" offset="0.0"/>
        </distribution>

	<distribution id="origin" spec="beast.math.distributions.Prior" x="@FBDorigin">
			<distr id="FBDoriginUniform" spec="beast.math.distributions.Uniform" upper="Infinity"/>
        </distribution>

        
        <!-- BM model prior -->
        <!-- trait evolutionary rate, the diagonal elements in the variance-covariance matrix -->
        <distribution id="varValuesPrior" spec="beast.math.distributions.Prior" x="@varValues">
	        <distr id="LogNormal.varValues" spec="beast.math.distributions.LogNormalDistributionModel" S="0.3" M="1.0"/>
        </distribution>
        <!-- trait correlations, the off-diagonal elements in the variance-covariance matrix -->
        <distribution id="covValuesPrior" spec="beast.math.distributions.Prior" x="@covValues">
	        <distr id="Uniform.correlation" spec="beast.math.distributions.Uniform" lower="-1.0" upper="1.0"/>
        </distribution>
        <!-- trait values at the root -->
        <distribution id="MeanPrior" spec="beast.math.distributions.Prior" x="@rootValues">
	        <distr id="Normal.Mean" spec="beast.math.distributions.Normal" mean="0.0" sigma="2.0"/>
        </distribution>


	<!-- insert prior fossil ages here -->
        <!--PRIOR_FOSSIL_AGES_PLACEHOLDER-->


    </distribution>
    <!-- END prior -->


    <!-- START likelihood -->
    <distribution id="likelihood" spec="util.CompoundDistribution" useThreads="false">


     <!-- START Morphological likleihood-->
        <distribution id="PCMLikelihood" spec="contraband.prunelikelihood.BMPruneLikelihood">
			<tree idref="TheTree"/>
			<!-- trait values for species of interest, an array of elements in the trait matrix-->
            <!-- For example
                  trait1 trait2 trait3
            sp1     T11    T12    T13
            sp2     T21    T22    T23
            sp3     T31    T32    T33
            the input here should be T11 T12 T13 T21 T22 T23 T31 T32 T33
            -->
            <traits id="oneTraitData" spec="parameter.RealParameter" minordimension="MINORDIMENSION_PLACEHOLDER" 
		    keys= "ONETRAITDATA_PLACEHOLDER">
		    TRAITDATA_PLACEHOLDER
            </traits>

            <!-- the morphological clock model used here is equivalent to a strict clock -->
            <!-- the rates input here refers to the branch rates -->
			<branchRateModel id="rateCatClock" spec="contraband.clock.RateCategoryClockModel" nCat="1">
                <rates id="rateValues" spec="parameter.RealParameter">1</rates>
                <rateCatAssign id="rateAssignments" spec="parameter.IntegerParameter" lower="0" upper="1">0</rateCatAssign>
                <tree idref="TheTree"/>
            </branchRateModel>

            <!-- parameters in the BM model -->
            <!-- here we assume each trait has its own evolutionary rate -->
            <!-- if we assume all traits to share one common rate, we should set the flag by oneRateOnly="true" -->
            <!-- the flag upperMatrix="true" here is to ensure the non-singular variance-covariance matrix -->
            <nodeMath id="pcmNodeMath" spec="contraband.math.NodeMath" traits="@oneTraitData" upperMatrix="true">
            	<sigmasq id="varValues" spec="parameter.RealParameter">1.0</sigmasq>
            	<correlation id="covValues" spec="parameter.RealParameter">0.0</correlation>
            	<rootValues id="rootValues" spec="parameter.RealParameter">0.0</rootValues>
            </nodeMath>
        </distribution>
        <!-- END Morphological likleihood -->
	</distribution> 
	<!-- END Likelihood -->
	</distribution> 
	<!-- END Posterior -->
	<!-- 
  	<operator id="MutationRateScaler" spec="ScaleOperator" parameter="@mutationRate" scaleFactor="0.75" weight="2.0"/>
    	-->
    <operator id="FBDDiveRateScaler" spec="ScaleOperator" parameter="@birthRate" scaleFactor="0.75" weight="2.0"/>
    <operator id="deathRateScaler" spec="ScaleOperator" parameter="@deathRate" scaleFactor="0.75" weight="2.0"/>
    <operator id="FBDSamplingPropScaler" spec="ScaleOperator" parameter="@samplingRate" scaleFactor="0.75" weight="2.0"/> 
	<operator id="FBDoriginScaler" spec="ScaleOperator" parameter="@FBDorigin" scaleFactor="0.75" weight="2.0"/>
    
	<operator id="VarValueScaler" spec="ScaleOperator" parameter="@varValues" scaleFactor="0.75" weight="6.0"/>
    <operator id="CoValueRandomWalk" spec="RealRandomWalkOperator" parameter="@covValues" windowSize="1.0" weight="10.0"/>
    <operator id="MeanRandomWalk" spec="RealRandomWalkOperator" parameter="@rootValues" windowSize="1.0" weight="6.0"/>
	
    <operator id="FBDLeafToSA" spec="LeafToSampledAncestorJump" tree="@TheTree" weight="10.0"/>    
    <operator id="FBDSAWilsonBalding" spec="SAWilsonBalding" tree="@TheTree" weight="10.0"/>
    <operator id="FBDSAWide" spec="SAExchange" isNarrow="false" tree="@TheTree" weight="10.0"/>
    <operator id="FBDSANarrow" spec="SAExchange" tree="@TheTree" weight="10.0"/>
    <operator id="FBDSAUniformOperator" spec="SAUniform" tree="@TheTree" weight="20.0"/>
    <operator id="FBDSATreeRootScaler" spec="SAScaleOperator" rootOnly="true" scaleFactor="0.95" tree="@TheTree" weight="1.0"/>
    <operator id="FBDSATreeScaler" spec="SAScaleOperator" scaleFactor="0.95" tree="@TheTree" weight="3.0"/>
	<!--PRIOR_FOSSIL_AGES_PLACEHOLDER_operator-->

    <logger id="tracelog" fileName="BMPruneLikelihood_calval_1.log" logEvery="PRINTGEN_PLACEHOLDER" model="@posterior" sanitiseHeaders="true" sort="smart">
      <log idref="posterior"/>
      <log idref="likelihood"/>
      <log idref="prior"/>
      <log id="TreeStats" spec="beast.evolution.tree.TreeStatLogger" tree="@TheTree"/>
	  <log id="SACountFBD" spec="beast.evolution.tree.SampledAncestorLogger" tree="@TheTree"/>
	  <log idref="varValues"/>
      <log idref="covValues"/>
      <log idref="rootValues"/>
      <log idref="birthRate"/>
      <log idref="deathRate"/>
      <log idref="samplingRate"/>
      <log idref="FBDrho"/>
      <log idref="FBDorigin"/>
	<!--PRIOR_FOSSIL_AGES_PLACEHOLDER_logger-->

    </logger>

    <logger id="screenlog" logEvery="PRINTGEN_PLACEHOLDER">
        <log idref="posterior"/>
        <log id="ESS.0" spec="util.ESS" arg="@posterior"/>
        <log idref="likelihood"/>
        <log idref="prior"/>
    </logger>

    <logger id="treelog" fileName="BMPruneLikelihood_calval_1.trees" logEvery="PRINTGEN_PLACEHOLDER" mode="tree">
        <log id="TreeWithMetaDataLogger" spec="beast.evolution.tree.TreeWithMetaDataLogger" tree="@TheTree"/>
    </logger>
  </run>
</beast>
